<!DOCTYPE html>
<html lang="en-nz">
<head>
    <title></title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content=""/>
    <meta property="og:title" content="" />
    <meta property="og:description" content=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <link rel="stylesheet" href="styles/loader.css"/>
    <link rel="stylesheet" href="styles/site.css"/>
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script type="text/javascript" src="scripts/jquery-3.7.1.min.js"></script>
    <style>

    </style>
</head>

<body>
    <div class="loader">
        <div class="loader-text"></div>
    </div>
    <div class="action-bar">
        <a class="github-link" href="" target="_blank" title="see the code repository on GitHub">
            <img src="assets/GitHub-Mark-32px.png" alt="github icon" />
        </a>
    </div>

    <div style="position: absolute;
    z-index: 10000; left: 100px;">
        <div><select id="travelFrom"></select></div>
        <div><select id="travelTo"></select></div>
        <div id="start-trigger" style="
        padding: 1em;
        background-color: #fff;">
            CLICK ME TO START
        </div>
        <div id="text-output">

        </div>
    </div>
    <div id="map"></div>
    
    <script src="scripts/util.js"></script>
    <script src="scripts/map-page.js"></script>
    <script src="scripts/path-finder.js"></script>
    <script>
        //let mappy = new MapPage();
        //console.log(mappy.allFeatureLayers.length)

        
        map = L.map('map').setView([-39.19340, 173.98926], 15);
        
        let allFeatureLayers = [];
        let availableBaseLayers = [];
        let currentLayer = null;
        let currentDisplayPath = null;

        document.getElementById("start-trigger").onclick = function(e) { DoSomeCrap(); };

        $(document).ready(function() {

            LoadDataFromDb(HandleDataLoad);

            availableBaseLayers = SetupAvailableBaseLayers();
            let wantedBase = GetTileLayer("OpenStreetMap", availableBaseLayers);

            map.addLayer(wantedBase);
            currentLayer = wantedBase;
        });

        function DoSomeCrap() {
            //console.log(allFeatureLayers);
            let nodeLayers = [];
            let joinLayers = [];
            // get collections of nodes and joins
            for(let i = 0; i < allFeatureLayers.length; i++) {
                //console.log("we're looking at layer index " + i)
                let layer = allFeatureLayers[i];
                //console.log(layer);
                if(layer.geometry.type == "Polygon") {
                    nodeLayers.push(layer)
                } 
                if (layer.geometry.type == "Point"){
                    joinLayers.push(layer)
                }
            }
            console.log("these are the joinLayers")
            console.log(joinLayers)

            let pathFinder = new PathFinder(nodeLayers, joinLayers);

            let travelFrom = $("#travelFrom").val();
            let travelTo = $("#travelTo").val();

            let path = pathFinder.CalculatePath(travelFrom, travelTo)
            console.log("THIS IS WHERE WE WENT")
            console.log(path)
            let travelCoordinates = [];
            let lastCoordinate = null;
            $("#text-output").html();
            for(let p=0; p<path.length; p++) {
                $("#text-output").append($("<div>").text(path[p].extended.name));
                if(path[p].extended.justTraversed) {
                    //if(p+1 < path.length) {
                        //travelCoordinates.push({ 'from': path[p].extended.justTraversed.coordinates, 'to': path[p+1].extended.justTraversed.coordinates })
                        // look I don't know why these are backwards, lets just move on with our lives
                        travelCoordinates.push([ path[p].extended.justTraversed.coordinates[1] , path[p].extended.justTraversed.coordinates[0] ]);
                    //}
                }
            }
            console.log("I think, these might be our path coordinates")
            console.log(travelCoordinates)
            
            if(currentDisplayPath) {
                this.map.removeLayer(currentDisplayPath);
            }
            currentDisplayPath = L.polyline(travelCoordinates, {color: 'red'}).addTo(this.map);

            var stopIcon = L.icon({
                iconUrl: 'assets/marker-end.png',
                iconSize:     [27, 43], // size of the icon
                iconAnchor:   [13, 43], // point of the icon which will correspond to marker's location
                popupAnchor:  [0, 0] // point from which the popup should open relative to the iconAnchor
            });
            var startIcon = L.icon({
                iconUrl: 'assets/marker-start.png',
                iconSize:     [27, 43], // size of the icon
                iconAnchor:   [13, 43], // point of the icon which will correspond to marker's location
                popupAnchor:  [0, 0] // point from which the popup should open relative to the iconAnchor
            });

            L.marker(travelCoordinates[0], {icon: startIcon}).addTo(map);
            L.marker(travelCoordinates[travelCoordinates.length-1], {icon: stopIcon}).addTo(map);

        }

        function HandleDataLoad(config, data) {
            let configJson =  JSON.parse(config);
            if(configJson) {
                this.map.setView(new L.LatLng(configJson.center.lat, configJson.center.lng), configJson.zoom);
            }

            var geoLayers = JSON.parse(data);
            if(geoLayers) {
                for (let geoLayer of geoLayers){
                    //console.log(geoLayer)
                    allFeatureLayers.push(geoLayer);

                }
            }

            UpdateLocationDropdowns();
            //this.HideLoadingPanel();
            //this.LevelChanged();
        }

        function GetListOfAllLocations() {
            let locations = [];
            //this.map.eachLayer(function(layer){
            for(let i = 0; i < allFeatureLayers.length; i++) {
                let layer = allFeatureLayers[i];
                //console.log(layer);
                //if(layer instanceof L.Path){
                    if(layer.extended) {
                        let locationId = layer.extended.id;
                        let locationName = layer.extended.name;
                        let location = { id: locationId, name: locationName };
                        if(locationId && locationName) {
                            locations.push(location);
                        } else {
                            console.log("there is a location without an id or name; id: " + locationId + ", name:" + locationName);
                        }
                    } else {
                        console.log("there is a layer with no extended object, very sad, can't add to list of locations")
                    }
                //}
            };
            locations = locations.sort((a, b) => a.name.localeCompare(b.name));
            return locations;
        }

        function UpdateLocationDropdowns() {
            let collection = this.GetListOfAllLocations();
            this.UpdateDropdown("travelFrom", collection);
            this.UpdateDropdown("travelTo", collection);
        }

        function LoadDataFromDb(completeHandler) {
            //this.ShowLoadingPanel();
            //this.ClearAllDrawingLayers();

            let mapKey = this.GetMapKey();
            if(mapKey) {
                // using the key, request data from the db
                let postData = { 'key' : mapKey };
                fetch('/getmapdata?' + new URLSearchParams({
                        key: mapKey
                    }), { headers: {
                            'Content-Type': 'application/json'
                    } })
                .then((response) => {
                    if(response.ok) {
                        return response.json();
                    } else {
                        return Promise.reject(response);
                    }
                })
                .then((dataResponse) => {
                    // we don't need the whole record, just the config and the data fields
                    //this.ShowDataOnMap(dataResponse.Config,dataResponse.Data);
                    completeHandler(dataResponse.Config,dataResponse.Data)
                })
                .catch(err => {
                    // there's got to be a better way!
                    console.log("we're in the error handler")
                    console.log(err)
                    if(err.json) {
                        err.json().then((json) => {
                            this.ShowUserMessage("danger", json.error)
                        })
                    } else {
                        this.ShowUserMessage("danger", err)
                    }
                    //this.HideLoadingPanel();
                })
            } else {
                this.ShowUserMessage("info", "No key was supplied in query string params so I couldn't load any data.")
                //this.HideLoadingPanel();
            }
        }



    </script>

    </body>
</html>